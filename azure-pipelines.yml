trigger:
- master
- develop
- feature/*
- release/*

stages:
- stage: Build
  displayName: Production build    
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')
  pool: 
    vmImage: 'ubuntu-latest'
  jobs:
  - job:
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '10.x'
      displayName: 'Install Node.js'

    - script: |
        npm install
        gulp default --gulpfile gulpfile.js
      displayName: 'npm install and run gulp'

    - task: CopyFiles@2
      inputs:
        Contents: |
          js/*min*
          css/*min*
          vendor/**
          img/**
          favicon.ico
          index.html
        TargetFolder: '$(Build.ArtifactStagingDirectory)'
        CleanTargetFolder: true

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)' 
        ArtifactName: 'build-output' 

- stage: Deploy
  condition: succeeded('Build')
  displayName: Deploy to release branch
  pool: 
    vmImage: 'ubuntu-latest'
  jobs:
  - job:
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'build-output'
        downloadPath: '$(System.ArtifactsDirectory)'

    - powershell: |
        git branch release
        git checkout release
        git add "$(System.ArtifactsDirectory)"
        git config user.name "Pipeline"
        git commit -a -m "Push build to release branch"
        git push